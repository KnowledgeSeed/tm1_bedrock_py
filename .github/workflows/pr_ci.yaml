name: Build & Test on Pull Request
on:
  pull_request:
    branches: [ "main" ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  TM1_ADDRESS: ${{ secrets.TM1_ADDRESS }}
  TM1_PORT: ${{ secrets.TM1_PORT }}
  TM1_USER: ${{ secrets.TM1_USER }}
  TM1_SSL: ${{ secrets.TM1_SSL }}

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        python-version: [ '3.12', '3.13' ]

    steps:
    - name: Set up WireGuard
      uses: egor-tensin/setup-wireguard@v1
      with:
          endpoint: 80.77.112.226:55000
          endpoint_public_key: ${{ secrets.PFSENSE_PUBLIC_KEY }}
          ips: 192.168.124.20/24
          allowed_ips: 192.168.124.0/24, 192.168.123.0/24
          private_key: ${{ secrets.ENDPOINT_GITHUB_PRIVATE_KEY }}

    - name: Update resolv.conf
      run: |
          echo "nameserver 192.168.123.2" | sudo tee /etc/resolv.conf > /dev/null
          echo "nameserver 8.8.8.8" | sudo tee -a /etc/resolv.conf > /dev/null
          echo "search knowledgeseed.local" | sudo tee -a /etc/resolv.conf > /dev/null

    - name: Set up Docker with insecure registry
      run: |
        echo '{"insecure-registries": ["kseed-docker1.knowledgeseed.local:3000"]}' | sudo tee /etc/docker/daemon.json
        sudo systemctl restart docker

    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
        python -m build

    - name: Run unit tests
      run: |
        cd tests
        echo "Running unit tests..."
        pytest test_unit.py
